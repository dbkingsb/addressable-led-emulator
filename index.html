<html>
<head>
	<style>
		body { background: black; }
		canvas { border: 1px solid gray; }
	</style>
	<script type="text/javascript">
		var refreshRate = 100;
		var fallRate = .090;
		var stringLedCount = 18;
		var stringLedSpacing = 25;
		var stringLead = 10;
		var fallOff = 20;
		var canvas;
		var ctx;
		var frameTs;
		var lastFrameTs;
		var model = {
			lastFrameTs: Date.now(),
			frameTs: Date.now(),
			snowflakes: [
				{x:100, y: 0}
			]
		};

		function init() {
			canvas = document.getElementById('myCanvas');
			ctx = canvas.getContext('2d');
			requestFrame();
			modelSnowflakes();
		}
		function getRgbArr() {
			var rgbArr = [];
			for (var i=0; i<model.snowflakes.length; i++) {
				var sf = model.snowflakes[i];
				for (var k=0; k<stringLedCount; k++) {
					var ledStartIdx = i*stringLedCount + k*3;
					// remove abs here, and break when diff is positve over falloff
					var diff = Math.abs((k*stringLedSpacing+stringLead) - sf.y);
					var intensity = 0;
					if (diff < fallOff) {
						intensity = Math.floor(255 / fallOff * (fallOff-diff));
					}
					rgbArr[ledStartIdx] = rgbArr[ledStartIdx+1] = rgbArr[ledStartIdx+2] = intensity;					
				}
			}
			return rgbArr;
		}
		function draw(rgbArr) {

			// frame init
			frameTs = Date.now();
			if (!lastFrameTs) {
				lastFrameTs = frameTs;
			}

			// clear canvas
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			// LED string model
			for (var i=0; i<stringLedCount; i++) {
				ctx.beginPath();
				ctx.strokeStyle = "rgb(100,100,100)";
				var r = rgbArr[i*3];
				var g = rgbArr[i*3+1];
				var b = rgbArr[i*3+2];
				if (r || g || b) {
					ctx.fillStyle = "rgb("+r+","+g+","+b+")";
				}
				else {
					ctx.fillStyle = "rgb(0,0,0)";
				}
				ctx.arc(120, i*stringLedSpacing+stringLead, 5, 0, Math.PI*2, false);
				ctx.stroke();
				ctx.fill();
			}

			// The "real" snowflakes being modeled
			drawSnowflakes();

			// frame conclusion
        	lastFrameTs = frameTs;
			requestFrame();
		}
		function drawSnowflakes() {
			for (var i=0; i<model.snowflakes.length; i++) {
				var sf = model.snowflakes[i];
				ctx.beginPath();
				ctx.fillStyle = "rgb(244,3,244)";
	        	ctx.arc(sf.x,sf.y,5,0,Math.PI*2,false);
	        	ctx.fill();				
			}
		}
		function requestFrame() {
			setTimeout(function() {
				draw(getRgbArr());
			}, refreshRate);
		}
		function modelSnowflakes() {
			// frame init
			model.frameTs = Date.now();
			if (!model.lastFrameTs) {
				model.lastFrameTs = model.frameTs;
			}
			// move
			for(var i=0; i<model.snowflakes.length; i++) {
				var sf = model.snowflakes[i];
				sf.y = drop(sf.y, model.frameTs-model.lastFrameTs);
			}
			// conclude
			model.lastFrameTs = model.frameTs;
			setTimeout(function() {
				modelSnowflakes();
			}, refreshRate);
		}
		function drop(y, dt) {
			var newY = y ? y : 0;
			newY += dt * fallRate;
			if (newY>canvas.height) {
				newY=0;
			}
			return newY;
		}
	</script>
</head>
<body onload="init();">
	<canvas id="myCanvas" width="600" height="500"></canvas>
</body>
</html>