<html>
<head>
	<style>
		body { background: black; color:white; }
		canvas { border: 1px solid gray; }
	</style>
	<script type="text/javascript">
		var refreshRate = 50;
		var fallRate = .05;
		var failRateVariance = .5; 
		var stringCount = 12;
		var stringLedCount = 18;
		var stringLedSpacing = 25;
		var stringLedLead = 10;
		var stringSpacing = 100;
		var stringLead = 0;
		var intensityThresh = 20;
		var snowflakeStringDensity = 2;
		var drawModel = true;
		var canvas;
		var ctx;
		var frameTs;
		var lastFrameTs;
		var model = {
			lastFrameTs: Date.now(),
			frameTs: Date.now(),
			snowflakes: []
		};

		function init() {
			canvas = document.getElementById('myCanvas');
			ctx = canvas.getContext('2d');
			requestFrame();
			modelSnowflakes();
		}
		function getRgbArr() {
			// prefill is not necessary
			var rgbArr = [];
			for (var i=0; i<model.snowflakes.length; i++) {
				var sf = model.snowflakes[i];

				var nearByLedIdxs = []
				var fuzzyLedIdx = (sf.y-stringLedLead) / stringLedSpacing ;
				if (fuzzyLedIdx % 1 == 0) {
					nearByLedIdxs.push(fuzzyLedIdx);
				}
				else {
					if (Math.ceil(fuzzyLedIdx) < stringLedCount) {
						nearByLedIdxs.push(Math.floor(fuzzyLedIdx));
						nearByLedIdxs.push(Math.ceil(fuzzyLedIdx));
					}
				}

				for (var k=0; k<nearByLedIdxs.length; k++) {
					var ledIdx = nearByLedIdxs[k];
					var diff = Math.abs((ledIdx*stringLedSpacing+stringLedLead) - sf.y);
					var intensity = 0;
					if (diff < intensityThresh) {
						intensity = Math.floor(255 / intensityThresh * (intensityThresh-diff));
					}
					var ledStartIdx = sf.x*stringLedCount*3 + ledIdx*3;
					rgbArr[ledStartIdx] = rgbArr[ledStartIdx+1] = rgbArr[ledStartIdx+2] = intensity;					
				}
			}
			return rgbArr;
		}
		function draw(rgbArr) {

			// frame init
			frameTs = Date.now();
			if (!lastFrameTs) {
				lastFrameTs = frameTs;
			}

			// clear canvas
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			// LED strings
			for (var i=0; i<stringCount; i++) {
				for (var k=0; k<stringLedCount; k++) {
					ctx.beginPath();
					ctx.strokeStyle = "rgb(100,100,100)";
					var r = rgbArr[i*stringLedCount*3 + k*3];
					var g = rgbArr[i*stringLedCount*3 + k*3+1];
					var b = rgbArr[i*stringLedCount*3 + k*3+2];
					if (r || g || b) {
						ctx.fillStyle = "rgb("+r+","+g+","+b+")";
					}
					else {
						ctx.fillStyle = "rgb(0,0,0)";
					}
					ctx.arc(i*getStringSpacing()+getStringLead(), k*stringLedSpacing+stringLedLead, 5, 0, Math.PI*2, false);
					ctx.stroke();
					ctx.fill();
				}
			}

			// The "real" snowflakes being modeled
			if (drawModel) {
				drawSnowflakes();
			}

			// frame conclusion
        	lastFrameTs = frameTs;
			requestFrame();
		}
		function getStringSpacing() {
			return canvas.width / stringCount;
		}
		function getStringLead() {
			return getStringSpacing() / 2;
		}
		function drawSnowflakes() {
			for (var i=0; i<model.snowflakes.length; i++) {
				var sf = model.snowflakes[i];
				var x = getStringLead() + sf.x*getStringSpacing() - 20;
				ctx.beginPath();
				ctx.fillStyle = "rgb(244,3,244)";
	        	ctx.arc(x,sf.y,5,0,Math.PI*2,false);
	        	ctx.fill();				
			}
		}
		function requestFrame() {
			setTimeout(function() {
				draw(getRgbArr());
			}, refreshRate);
		}
		function modelSnowflakes() {
			// frame init
			model.frameTs = Date.now();
			if (!model.lastFrameTs) {
				model.lastFrameTs = model.frameTs;
			}
			// snowflake init
			if (model.snowflakes.length==0) {
				for (var i=0; i<stringCount; i++) {
					for (var j=0; j<snowflakeStringDensity; j++) {
						model.snowflakes.push(createSnowflake(i));
					}
				}
			}
			// move
			for (var i=0; i<model.snowflakes.length; i++) {
				var sf = model.snowflakes[i];
				sf.y = drop(sf.y, sf.fallRate, model.frameTs-model.lastFrameTs);
				// destroy snowflake once it falls beyond the string, and create a new one
				if (sf.y > getLowestLedY() + intensityThresh) {
					model.snowflakes.push(createSnowflake(sf.x));
					model.snowflakes.splice(i,1);
				}
			}
			// conclude
			model.lastFrameTs = model.frameTs;
			setTimeout(function() {
				modelSnowflakes();
			}, refreshRate);
		}
		function createSnowflake(stringIdx) {
			return {
				x:stringIdx, y:0,
				fallRate: (fallRate+fallRate*failRateVariance) - Math.random()*fallRate*failRateVariance*2
			}			
		}
		function drop(y, s, dt) {
			var newY = y ? y : 0;
			newY += dt * s;
			return newY;
		}
		function getLowestLedY() {
			return stringLedCount * stringLedSpacing + stringLedLead;
		}
		function newFilledArray(len, val) {
		    var rv = new Array(len);
		    while (--len >= 0) {
		        rv[len] = val;
		    }
		    return rv;
		}
	</script>
</head>
<body onload="init();">
	<canvas id="myCanvas" width="800" height="500"></canvas><br>
	<button onclick="drawModel=!drawModel">Toggle Model</button>
</body>
</html>